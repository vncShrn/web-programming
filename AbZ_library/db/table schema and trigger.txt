CREATE TABLE `author` (
  `AUTHOR_ID` int(5) NOT NULL AUTO_INCREMENT,
  `NAME` varchar(30) NOT NULL DEFAULT '',
  PRIMARY KEY (`AUTHOR_ID`),
  UNIQUE KEY `NAME_UNIQUE` (`NAME`)
) ENGINE=InnoDB AUTO_INCREMENT=129 DEFAULT CHARSET=latin1;

CREATE TABLE `book` (
  `ISBN` varchar(20) NOT NULL DEFAULT '',
  `TITLE` varchar(100) NOT NULL,
  `DESCRIPTION` varchar(200) DEFAULT NULL,
  `PUBLISHER` varchar(15) NOT NULL,
  `EDITION` varchar(10) DEFAULT NULL,
  `YEAR` year(4) DEFAULT NULL,
  `COVER_IMG` varchar(30) DEFAULT NULL,
  `CHECK_OUT_POLICY` int(3) DEFAULT '90',
  `COPIES` int(3) DEFAULT '1',
  `AVAILABLE` int(3) DEFAULT '1',
  `CATEG_ID` int(11) NOT NULL,
  PRIMARY KEY (`ISBN`),
  KEY `FK_LOC_ID_idx` (`CATEG_ID`),
  CONSTRAINT `FK_CATEG_ID` FOREIGN KEY (`CATEG_ID`) REFERENCES `category` (`CATEG_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE `book_author` (
  `ISBN` varchar(20) NOT NULL,
  `AUTHOR_ID` int(5) NOT NULL DEFAULT '0',
  PRIMARY KEY (`ISBN`,`AUTHOR_ID`),
  KEY `FK_AUTHOR_ID_idx` (`AUTHOR_ID`),
  CONSTRAINT `FK_AUTHOR_ID` FOREIGN KEY (`AUTHOR_ID`) REFERENCES `author` (`AUTHOR_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_ISBN` FOREIGN KEY (`ISBN`) REFERENCES `book` (`ISBN`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE `category` (
  `CATEG_ID` int(11) NOT NULL AUTO_INCREMENT,
  `NAME` varchar(45) NOT NULL,
  `LOCATION_ID` int(11) DEFAULT NULL,
  PRIMARY KEY (`CATEG_ID`),
  UNIQUE KEY `NAME_UNIQUE` (`NAME`),
  KEY `FK_LOC_ID_idx` (`LOCATION_ID`),
  CONSTRAINT `FK_LOC_ID` FOREIGN KEY (`LOCATION_ID`) REFERENCES `location` (`LOCATION_ID`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

CREATE TABLE `loans` (
  `LOAN_ID` int(11) NOT NULL AUTO_INCREMENT,
  `ISBN` varchar(20) NOT NULL DEFAULT '',
  `NET_ID` varchar(20) NOT NULL DEFAULT '',
  `BORROWED_DATE` date NOT NULL,
  `DUE_DATE` date NOT NULL,
  `RETURNED_DATE` date DEFAULT NULL,
  `FINE_AMT` float DEFAULT NULL,
  `IS_FINE_PAID` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`LOAN_ID`,`ISBN`,`NET_ID`),
  KEY `fk_1_idx` (`ISBN`),
  KEY `fk_2_idx` (`NET_ID`),
  CONSTRAINT `fk_1` FOREIGN KEY (`ISBN`) REFERENCES `book` (`ISBN`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_2` FOREIGN KEY (`NET_ID`) REFERENCES `user` (`NET_ID`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1;

CREATE TABLE `location` (
  `LOCATION_ID` int(11) NOT NULL AUTO_INCREMENT,
  `FLOOR` int(2) DEFAULT NULL,
  `AISLE` int(2) DEFAULT NULL,
  PRIMARY KEY (`LOCATION_ID`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

CREATE TABLE `user` (
  `NET_ID` varchar(20) NOT NULL DEFAULT '',
  `FNAME` varchar(20) NOT NULL,
  `LNAME` varchar(20) NOT NULL,
  `EMAIL` varchar(30) NOT NULL,
  `PHONE` int(10) NOT NULL,
  `PWD` varchar(100) NOT NULL,
  `IS_ADMIN` tinyint(1) NOT NULL,
  `BALANCE` float DEFAULT NULL,
  `IS_BAL_PAID` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`NET_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE DEFINER=`root`@`localhost` TRIGGER `proj`.`loans_AFTER_INSERT` AFTER INSERT ON `loans` FOR EACH ROW
BEGIN
    UPDATE BOOK SET AVAILABLE= AVAILABLE-1 WHERE BOOK.ISBN= NEW.ISBN;
END


CREATE DEFINER=`root`@`localhost` TRIGGER `proj`.`loans_AFTER_UPDATE` 
AFTER UPDATE ON `loans` FOR EACH ROW
BEGIN
  IF (OLD.RETURNED_DATE IS NULL AND NEW.RETURNED_DATE IS NOT NULL) THEN
    UPDATE BOOK SET AVAILABLE= AVAILABLE+1 WHERE BOOK.ISBN= NEW.ISBN;
  END IF;
  IF ( NEW.FINE_AMT > OLD.FINE_AMT) THEN
    UPDATE USER SET BALANCE = BALANCE+NEW.FINE_AMT WHERE USER.NET_ID= NEW.NET_ID;
  END IF;  
  END
